{- if .Values.grafanaDashboard.enabled }
apiVersion: v1
kind: ConfigMap
metadata:
  name: { include "r8limiter.fullname" . }-grafana-dashboard
  {- if .Values.grafanaDashboard.namespace }
  namespace: { .Values.grafanaDashboard.namespace }
  {- end }
  labels:
    {- include "r8limiter.labels" . | nindent 4 }
    {- with .Values.grafanaDashboard.labels }
    {- toYaml . | nindent 4 }
    {- end }
data:
  r8limiter-dashboard.json: |
{
  toJson (include "r8limiter.dashboard" .) | indent 4
}
{- end }

{- define "r8limiter.dashboard" -}
{
  "annotations": {
    "list": []
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "panels": [
    {
      "type": "stat",
      "title": "QPS (total)",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(rate(requests_total[1m]))",
          "legendFormat": "qps"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "Allow/Deny Ratio",
      "gridPos": {
        "x": 6,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(rate(requests_total{result=\"allow\"}[5m])) / clamp_min(sum(rate(requests_total[5m])), 0.0001)",
          "legendFormat": "allow_ratio"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Latency p95 / p99",
      "gridPos": {
        "x": 0,
        "y": 4,
        "w": 12,
        "h": 8
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(request_latency_seconds_bucket[5m])))",
          "legendFormat": "p95"
        },
        {
          "expr": "histogram_quantile(0.99, sum by (le) (rate(request_latency_seconds_bucket[5m])))",
          "legendFormat": "p99"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "QPS by Result",
      "gridPos": {
        "x": 0,
        "y": 12,
        "w": 12,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (result) (rate(requests_total[1m]))",
          "legendFormat": "{{result}}"
        }
      ]
    }
  ],
  "refresh": "10s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": [
    "r8limiter"
  ],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timezone": "",
  "title": "r8limiter Overview",
  "version": 1
}
{- end -}
